<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Siri-like Web Voice Assistant</title>
<style>
  :root{
    --bg:#0f1720; --card:#0b1220; --muted:#94a3b8; --accent:#22c55e; --accent2:#60a5fa;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%; margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,#07111a 0%, #08131a 100%); color:#e6eef8}
  .wrap{max-width:980px; margin:28px auto; padding:20px;}
  header{display:flex;align-items:center;gap:16px}
  h1{font-size:20px;margin:0}
  .subtitle{color:var(--muted); font-size:13px}
  .controls{display:flex;gap:8px; margin-top:14px; flex-wrap:wrap}
  button{background:var(--card); color:inherit;border:1px solid rgba(255,255,255,0.03); padding:10px 12px; border-radius:8px; cursor:pointer}
  button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#022; font-weight:700}
  .panel{margin-top:18px; display:grid; grid-template-columns: 1fr 360px; gap:16px}
  .card{background:var(--glass); border-radius:10px; padding:14px; box-shadow:0 6px 24px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
  #left {min-height:420px}
  #right {min-height:420px}
  #transcript{min-height:120px; background: rgba(255,255,255,0.02); padding:10px; border-radius:8px; color:#dff0d8}
  #log{height:260px; overflow:auto; font-size:13px; color:var(--muted); background: rgba(255,255,255,0.01); padding:8px; border-radius:6px}
  .row{display:flex; gap:8px; align-items:center}
  label{font-size:13px;color:var(--muted)}
  input[type="text"]{flex:1; padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03); background:transparent; color:inherit}
  .hint{font-size:12px;color:var(--muted); margin-top:8px}
  .smallbtn{padding:6px 8px; font-size:13px}
  .status{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03); color:var(--muted); font-size:13px}
  .command-list{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:10px}
  .cmd{background:rgba(255,255,255,0.02); padding:8px;border-radius:6px;font-size:13px;color:var(--muted)}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .kbd{background:#071827;padding:4px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04); font-weight:700}
  .muted{color:var(--muted)}
  @media (max-width:900px){ .panel{grid-template-columns:1fr} #right{order:2} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Siri â€” Web Voice Assistant</h1>
        <div class="subtitle">Speak commands or type them. Works in Chrome/Edge. No server required.</div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div class="status" id="listenStatus">Idle</div>
        <div style="height:6px"></div>
        <div class="muted" style="font-size:12px">Language: <span id="langLabel">English (en-US)</span></div>
      </div>
    </header>

    <div class="controls">
      <button id="btnStart" class="primary">Start Listening</button>
      <button id="btnStop">Stop</button>
      <button id="btnWake">Wake-word: <span id="wakeState">Off</span></button>
      <button id="btnToggleVoice">Toggle Voice Reply</button>
      <button id="btnClearLog" class="smallbtn">Clear Log</button>
      <select id="langSelect" style="padding:8px;border-radius:8px;background:var(--card);color:inherit">
        <option value="en-US">English (en-US)</option>
        <option value="hi-IN">Hindi (hi-IN)</option>
      </select>
    </div>

    <div class="panel">
      <div id="left" class="card">
        <h3>Say or type a command</h3>
        <div id="transcript">Press <span class="kbd">Start Listening</span> and speak â€” or type below.</div>

        <div style="margin-top:12px" class="row">
          <input id="cmdInput" type="text" placeholder="e.g. open youtube / what is the time / search cats" />
          <button id="btnSend" class="smallbtn">Send</button>
        </div>

        <div class="hint">Tip: Say <b>"Hey Siri"</b> to activate when wake-word is ON. Try: <em>open youtube, search weather Chennai, time, wiki Tesla, calculate 12*8, set timer 10 seconds</em></div>

        <div style="margin-top:12px">
          <strong>Quick commands</strong>
          <div class="command-list">
            <div class="cmd">open youtube</div>
            <div class="cmd">open google</div>
            <div class="cmd">search cats</div>
            <div class="cmd">time</div>
            <div class="cmd">date</div>
            <div class="cmd">wiki tesla</div>
            <div class="cmd">calculate 12 + 34</div>
            <div class="cmd">set timer 15 seconds</div>
            <div class="cmd">play music</div>
            <div class="cmd">tell me a joke</div>
          </div>
        </div>
      </div>

      <div id="right" class="card">
        <h3>Activity Log</h3>
        <div id="log"></div>

        <h4 style="margin-top:12px">Settings</h4>
        <div class="row" style="margin-top:6px">
          <label>Voice reply:</label>
          <input type="checkbox" id="chkVoice" checked />
        </div>
        <div class="row" style="margin-top:6px">
          <label>Continuous listen:</label>
          <input type="checkbox" id="chkContinuous" />
        </div>
        <div style="margin-top:10px" class="muted">Supported in Chrome/Edge. Safari support is limited.</div>
      </div>
    </div>

    <footer>
      Built for you â€” say hi and try commands. DEVELOPED BY RUDRANSH PANDEY (A GENIUS).  
    </footer>
  </div>

<script>
/* -------------------------
  Siri-like Web Voice Assistant
  - Uses Web Speech API (SpeechRecognition & SpeechSynthesis)
  - No backend required
  - Commands handled locally (search, open, wiki, calculate, timer, jokes, music, etc.)
  ------------------------- */

(function(){
  // Feature detection
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const synth = window.speechSynthesis;

  // UI elements
  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const btnWake = document.getElementById('btnWake');
  const btnToggleVoice = document.getElementById('btnToggleVoice');
  const btnClearLog = document.getElementById('btnClearLog');
  const langSelect = document.getElementById('langSelect');
  const langLabel = document.getElementById('langLabel');
  const listenStatus = document.getElementById('listenStatus');
  const transcriptEl = document.getElementById('transcript');
  const cmdInput = document.getElementById('cmdInput');
  const btnSend = document.getElementById('btnSend');
  const logEl = document.getElementById('log');
  const chkVoice = document.getElementById('chkVoice');
  const chkContinuous = document.getElementById('chkContinuous');
  const wakeStateSpan = document.getElementById('wakeState');

  // State
  let recognition = null;
  let listening = false;
  let wakeWordOn = false;
  let lastTranscript = '';
  let lang = 'en-US';
  let continuous = false;

  // Jokes array
  const jokes = [
    "Why did the developer go broke? Because he used up all his cache.",
    "Why do programmers prefer dark mode? Because the light attracts bugs.",
    "I told my computer I needed a break, and it said â€” 'No problem, I'll go to sleep.'"
  ];

  // Helper: add to log
  function log(message, type='info'){
    const time = new Date().toLocaleTimeString();
    const el = document.createElement('div');
    el.innerHTML = `<strong style="color:#9ae6b4">${time}</strong> â€” <span style="color:${type==='err'?'#ff7b7b':'#cfe8ff'}">${escapeHtml(message)}</span>`;
    logEl.prepend(el);
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

  // Speak helper
  function speak(text, opts = {}){
    if(!chkVoice.checked) return;
    if(!synth) return;
    try {
      const u = new SpeechSynthesisUtterance(text);
      u.lang = opts.lang || lang;
      u.rate = opts.rate || 1.0;
      u.pitch = opts.pitch || 1.0;
      synth.cancel(); // stop previous
      synth.speak(u);
    } catch (e) {
      console.error('synth error', e);
    }
  }

  // Initialize recognition
  function setupRecognition(){
    if(!SpeechRecognition) {
      listenStatus.textContent = 'SpeechRecognition not supported';
      btnStart.disabled = true; btnStop.disabled = true;
      return;
    }
    recognition = new SpeechRecognition();
    recognition.lang = lang;
    recognition.interimResults = false;
    recognition.continuous = continuous; // controlled by checkbox
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      listening = true;
      listenStatus.textContent = 'Listening...';
      btnStart.textContent = 'Listening';
      log('Voice recognition started');
    };

    recognition.onend = () => {
      listening = false;
      listenStatus.textContent = 'Idle';
      btnStart.textContent = 'Start Listening';
      log('Voice recognition stopped', 'info');
      // If continuous/chkContinuous is on, restart automatically
      if(chkContinuous.checked && recognition){
        setTimeout(()=> { try{ recognition.start() } catch(e){} }, 250);
      }
    };

    recognition.onerror = (ev) => {
      log('Speech error: ' + ev.error, 'err');
    };

    recognition.onresult = (ev) => {
      const res = ev.results[ev.results.length - 1][0].transcript.trim();
      lastTranscript = res;
      transcriptEl.textContent = 'Heard: "' + res + '"';
      log('Heard: ' + res);
      // If wake-word on, check for it first
      if(wakeWordOn){
        if(res.toLowerCase().includes('hey siri') || res.toLowerCase().includes('ok siri')){
          speak('Yes, I am listening');
          log('Wake word detected â€” ready for command');
          // start a short recognition for the next command (if not continuous)
          // If continuous: we are already listening
          return;
        }
        // If wake word is required and not present, ignore
        // But be forgiving: if phrase contains wake word + command, strip it
        if(res.toLowerCase().startsWith('hey siri')) {
          const cmd = res.toLowerCase().replace(/^hey siri[, ]*/,'').trim();
          if(cmd) handleCommand(cmd);
          return;
        } else {
          // Not wake word â€” ignore spoken phrase
          log('Ignored (wake-word on)', 'info');
          return;
        }
      } else {
        // Not wake-word mode: directly handle command
        handleCommand(res);
      }
    };
  }

  // Command handler
  async function handleCommand(textRaw){
    const text = textRaw.trim();
    if(!text) return;
    // show in UI
    addTranscriptEntry('User: ' + text);
    // Basic parsing
    const lower = text.toLowerCase();

    // 1. small talk
    if(/^(hi|hello|hey|hey siri)\b/.test(lower)){
      speak('Hello ' + (currentUserName() || '') + '. How can I help?');
      addTranscriptEntry('Siri: greeting');
      return;
    }

    // 2. time/date
    if(lower.includes('time')) {
      const now = new Date();
      const out = `It is ${now.toLocaleTimeString()}`;
      speak(out);
      addTranscriptEntry('Siri: ' + out);
      return;
    }
    if(lower.includes('date')) {
      const now = new Date();
      const out = `Today is ${now.toLocaleDateString()}`;
      speak(out);
      addTranscriptEntry('Siri: ' + out);
      return;
    }

    // 3. open website
    if(lower.match(/\bopen (youtube|google|wikipedia|github)\b/)) {
      let site = 'https://google.com';
      if(lower.includes('youtube')) site = 'https://youtube.com';
      else if(lower.includes('wikipedia')) site = 'https://wikipedia.org';
      else if(lower.includes('github')) site = 'https://github.com';
      speak('Opening ' + site.replace(/^https?:\/\//,''));
      window.open(site, '_blank');
      addTranscriptEntry('Siri: opening ' + site);
      return;
    }

    // 4. search <query>
    if(lower.startsWith('search ') || lower.startsWith('google ')) {
      const q = text.replace(/^(search|google)\s+/i,'').trim();
      if(!q){ speak('What do you want me to search?'); return; }
      speak('Searching Google for ' + q);
      const url = 'https://www.google.com/search?q=' + encodeURIComponent(q);
      window.open(url, '_blank');
      addTranscriptEntry('Siri: searched for ' + q);
      return;
    }

    // 5. wiki <term> -> fetch first paragraph from Wikipedia
    if(lower.startsWith('wiki ') || lower.startsWith('wikipedia ')) {
      const term = text.replace(/^(wiki|wikipedia)\s+/i,'').trim();
      if(!term){ speak('What do you want from Wikipedia?'); return; }
      speak('Searching Wikipedia for ' + term);
      addTranscriptEntry('Siri: fetching wikipedia for ' + term);
      try {
        const api = 'https://en.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(term);
        const r = await fetch(api);
        if(!r.ok) { speak('No Wikipedia page found for ' + term); return; }
        const j = await r.json();
        const extract = j.extract ? j.extract.split('. ').slice(0,2).join('. ') + '.' : 'No summary available.';
        speak(extract);
        addTranscriptEntry('Wiki: ' + extract);
      } catch (e) {
        speak('Failed to fetch Wikipedia.');
        addTranscriptEntry('Wiki error: ' + e.message, 'err');
      }
      return;
    }

    // 6. calculate <expr>
    if(lower.startsWith('calculate ') || lower.startsWith('what is ') || /^[0-9\+\-\*\/\. ]+$/.test(lower)) {
      // window.eval is dangerous â€” limit to math chars
      const expr = text.replace(/^(calculate|what is)\s+/i,'').replace(/[^0-9+\-*/(). %]/g,'');
      if(!expr){ speak('I could not parse the expression'); return; }
      try {
        // safe-ish eval using Function
        const val = Function('"use strict";return (' + expr + ')')();
        speak('The result is ' + val);
        addTranscriptEntry('Calc: ' + expr + ' = ' + val);
      } catch (e) {
        speak('Sorry, cannot calculate that.');
        addTranscriptEntry('Calc error: ' + e.message, 'err');
      }
      return;
    }

    // 7. set timer X seconds/minutes
    if(lower.startsWith('set timer') || lower.startsWith('timer ')) {
      // parse number and unit
      const m = lower.match(/(\d+)\s*(seconds|second|minutes|minute|secs|mins)?/);
      if(!m){ speak('Please tell me the time in seconds or minutes'); return; }
      let num = parseInt(m[1],10);
      let unit = (m[2]||'seconds').toLowerCase();
      let ms = (unit.startsWith('min')) ? num * 60 * 1000 : num * 1000;
      speak('Timer set for ' + num + ' ' + (unit.startsWith('min') ? 'minutes' : 'seconds'));
      addTranscriptEntry('Timer: ' + num + ' ' + unit);
      setTimeout(()=>{
        speak('Timer finished: ' + num + ' ' + (unit.startsWith('min') ? 'minutes' : 'seconds'));
        alert('Timer finished: ' + num + ' ' + unit);
      }, ms);
      return;
    }

    // 8. play music -> open YouTube playlist
    if(lower.includes('play music') || lower.includes('play song') || lower.includes('play some music')) {
      speak('Playing music');
      window.open('https://youtu.be/sUf2PtEZris?feature=shared', '_blank');
      return;
    }

    // 9. jokes
    if(lower.includes('joke')) {
      const j = jokes[Math.floor(Math.random()*jokes.length)];
      speak(j);
      addTranscriptEntry('Joke: ' + j);
      return;
    }

    // 10. utility: open site <url>
    const openMatch = lower.match(/^open (https?:\/\/\S+|\S+\.\S{2,})$/);
    if(openMatch) {
      const target = openMatch[1].startsWith('http') ? openMatch[1] : 'https://' + openMatch[1];
      speak('Opening ' + target);
      window.open(target, '_blank');
      return;
    }

    // 11. stop / exit listening
    if(lower.includes('stop listening') || lower.includes('stop') || lower.includes('exit')) {
      speak('Stopping voice recognition');
      stopListening();
      return;
    }

    // 12. help / list commands
    if(lower.includes('help') || lower.includes('commands')) {
      const msg = 'You can say: time, date, open youtube, search cats, wiki Tesla, calculate 12 plus 7, set timer 10 seconds, play music, tell me a joke';
      speak(msg);
      addTranscriptEntry('Help shown');
      return;
    }
// âœ… Extra: Physics Wallah app / site
    if(lower.includes("open pw") || lower.includes("physics wallah") || lower.includes("play pw")){
      speak("Opening Physics Wallah for you");
      // Try opening app via intent
      window.location.href = "intent://#Intent;package=in.eduwall.pwclassroom;scheme=pw;end";
      // Fallback â†’ website
      setTimeout(() => {
        window.open("https://www.pw.live/", "_blank");
      }, 1000);
      return;
    }
    // fallback: ask to search
    speak('I did not understand. Do you want me to search the web for ' + text + '?');
    if(confirm('Search web for "' + text + '"?')) {
      window.open('https://www.google.com/search?q=' + encodeURIComponent(text), '_blank');
    }
  }

  // Add transcript entry area (left)
  function addTranscriptEntry(txt, type='sys'){
    const p = document.createElement('div');
    p.style.marginTop = '8px';
    p.style.fontSize = '14px';
    p.style.color = (type==='err' ? '#ffb3b3' : '#dbeafe');
    p.textContent = txt;
    transcriptEl.appendChild(p);
    // scroll transcript into view
    transcriptEl.scrollTop = transcriptEl.scrollHeight;
  }

  // Controls events
  btnStart.addEventListener('click', () => {
    if(!recognition) setupRecognition();
    if(recognition && !listening){
      try { recognition.start(); } catch(e){ console.warn(e); }
    }
  });
  btnStop.addEventListener('click', stopListening);

  btnWake.addEventListener('click', ()=> {
    wakeWordOn = !wakeWordOn;
    wakeStateSpan.textContent = wakeWordOn ? 'On' : 'Off';
    log('Wake-word ' + (wakeWordOn ? 'enabled' : 'disabled'));
  });

  btnToggleVoice.addEventListener('click', ()=> {
    chkVoice.checked = !chkVoice.checked;
    log('Voice reply ' + (chkVoice.checked ? 'enabled' : 'disabled'));
  });

  btnClearLog.addEventListener('click', ()=> { logEl.innerHTML=''; transcriptEl.innerHTML=''; });

  chkContinuous.addEventListener('change', ()=>{
    if(recognition){
      recognition.stop();
      recognition = null;
      setupRecognition();
    }
    log('Continuous: ' + chkContinuous.checked);
  });

  langSelect.addEventListener('change', ()=> {
    lang = langSelect.value;
    langLabel.textContent = (lang==='hi-IN' ? 'Hindi (hi-IN)' : 'English (en-US)');
    if(recognition){
      recognition.lang = lang;
    }
    log('Language set to ' + lang);
  });

  btnSend.addEventListener('click', ()=> {
    const text = cmdInput.value.trim();
    if(!text) return;
    handleCommand(text);
    cmdInput.value='';
  });

  cmdInput.addEventListener('keydown', (e)=> { if(e.key==='Enter') btnSend.click(); });

  function stopListening(){
    if(recognition){
      try { recognition.stop(); } catch(e){}
      listening = false;
      listenStatus.textContent = 'Idle';
      log('Stopped listening');
    }
  }

  // current user name (from input)
  function currentUserName(){
    const n = document.getElementById('username');
    return n ? (n.value || '') : '';
  }

  // initial setup
  function init(){
    transcriptEl.textContent = 'Press Start Listening and speak. You can also type commands below.';
    lang = langSelect.value;
    // prepare recognition but don't start
    setupRecognition();
    log('Assistant ready');
  }

  init();

})();
</script>

<!-- ===================== ADD-ONS START (No changes above) ===================== -->
<style>
  /* Overlays & widgets for special features */
  #powerOverlay, #flashlightOverlay, #lockOverlay, #cameraOverlay {
    position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 9999;
  }
  #powerOverlay { background: #000; color:#fff; flex-direction: column; gap:18px; }
  #powerLogo { font-size: 26px; letter-spacing: 6px; opacity: 0; animation: fadeIn 1.2s ease forwards 0.4s }
  #powerSpinner { width:48px;height:48px;border-radius:50%; border:4px solid rgba(255,255,255,0.2); border-top-color:#fff; animation: spin 1s linear infinite}
  #restartText { font-size:13px; opacity:0.8 }
  @keyframes spin { to{ transform: rotate(360deg);} }
  @keyframes fadeIn { to{ opacity: 1} }

  #flashlightOverlay{ background:#fff }
  #lockOverlay { background: rgba(0,0,0,0.9); color:#dbeafe; flex-direction:column; gap:14px; text-align:center; }
  #lockOverlay .btn { padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.06); color:#fff; cursor:pointer }

  /* Camera overlay */
  #cameraOverlay { background: rgba(0,0,0,0.94); color:#fff; flex-direction: column; gap:10px; }
  #cameraView { width:min(92vw,720px); height: min(65vh,480px); background:#000; border-radius:12px; overflow:hidden }
  #cameraView video{ width:100%; height:100%; object-fit:cover }
  .overlayTopBar{
    position: fixed; top:14px; left:50%; transform: translateX(-50%);
    display:flex; gap:8px; align-items:center; background:rgba(255,255,255,0.06);
    padding:8px 12px; border:1px solid rgba(255,255,255,0.16); border-radius:999px; z-index:10000; color:#fff
  }
  .overlayTopBar button{ background:transparent; border:1px solid rgba(255,255,255,0.25); color:#fff; padding:8px 10px; border-radius:999px; cursor:pointer }

  /* Utility dock */
  .utility-dock{
    max-width:980px; margin: 10px auto 24px; padding:12px;
    display:grid; grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap:10px;
  }
  .util{ background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); color:#e6eef8; padding:12px; border-radius:12px; text-align:center; font-size:14px; cursor:pointer }
  .util small{ display:block; color:#94a3b8; font-size:12px; margin-top:4px }

  /* Badge line under footer */
  .badge-line{ text-align:center; color:#94a3b8; font-size:12px; margin-bottom:18px }
</style>

<!-- Quick utility dock (added, optional UI) -->
<div class="utility-dock">
  <div class="util" data-cmd="power off phone">Power Off<small>voice: power off phone</small></div>
  <div class="util" data-cmd="restart phone">Restart<small>voice: restart phone</small></div>
  <div class="util" data-cmd="flashlight on">Flashlight On<small>torch on</small></div>
  <div class="util" data-cmd="flashlight off">Flashlight Off</div>
  <div class="util" data-cmd="open camera">Open Camera</div>
  <div class="util" data-cmd="close camera">Close Camera</div>
  <div class="util" data-cmd="open whatsapp">Open WhatsApp</div>
  <div class="util" data-cmd="open gallery">Open Gallery</div>
  <div class="util" data-cmd="battery status">Battery Status</div>
  <div class="util" data-cmd="device info">Device Info</div>
  <div class="util" data-cmd="keep screen on">Keep Screen On</div>
  <div class="util" data-cmd="allow sleep">Allow Sleep</div>
  <div class="util" data-cmd="vibrate">Vibrate</div>
  <div class="util" data-cmd="lock screen">Lock Screen</div>
  <div class="util" data-cmd="unlock screen">Unlock Screen</div>
</div>

<!-- Overlays -->
<div id="powerOverlay">
  <div id="powerSpinner"></div>
  <div id="powerLogo">S H U T T I N G &nbsp; D O W N</div>
  <div id="restartText"></div>
</div>

<div id="flashlightOverlay"></div>

<div id="lockOverlay">
  <div style="font-size:28px; letter-spacing:2px">ðŸ”’ Screen Locked</div>
  <div>Say <b>"unlock screen"</b> or press the button below</div>
  <button class="btn" id="unlockBtn">Unlock</button>
</div>

<div id="cameraOverlay">
  <div class="overlayTopBar">
    <button id="btnCloseCamera">Close</button>
    <button id="btnSwitchCamera">Switch</button>
  </div>
  <div id="cameraView"><video id="camVideo" autoplay playsinline muted></video></div>
</div>

<div class="badge-line">Extra features added â€” original Siri assistant code remains unchanged.</div>

<script id="addons">
/* ==========================================================
   ADD-ON FEATURES (No changes to original code above)
   - Typed commands intercepted before original handler
   - Voice commands detected by observing transcript "User: ..."
   ========================================================== */

(function(){
  const transcriptEl = document.getElementById('transcript');
  const btnSend = document.getElementById('btnSend');
  const cmdInput = document.getElementById('cmdInput');
  const logEl = document.getElementById('log');

  // Overlays & elements
  const powerOverlay = document.getElementById('powerOverlay');
  const restartText = document.getElementById('restartText');
  const flashlightOverlay = document.getElementById('flashlightOverlay');
  const lockOverlay = document.getElementById('lockOverlay');
  const unlockBtn = document.getElementById('unlockBtn');
  const cameraOverlay = document.getElementById('cameraOverlay');
  const camVideo = document.getElementById('camVideo');
  const btnCloseCamera = document.getElementById('btnCloseCamera');
  const btnSwitchCamera = document.getElementById('btnSwitchCamera');

  let wakeLock = null;
  let camStream = null;
  let usingBackCam = true;

  function addLog(msg){
    const time = new Date().toLocaleTimeString();
    const div = document.createElement('div');
    div.innerHTML = `<strong style="color:#9ae6b4">${time}</strong> â€” <span style="color:#bfe1ff">${escapeHtml(msg)}</span>`;
    logEl.prepend(div);
  }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ---------- Feature actions ----------
  function powerOffAnimation(){
    powerOverlay.style.display = 'flex';
    restartText.textContent = '';
    // fade to black feel is already here; auto hide to simulate "powered off"
    setTimeout(()=> { document.body.style.filter='brightness(0)'; }, 600);
  }
  function restartAnimation(){
    powerOverlay.style.display = 'flex';
    restartText.textContent = 'Restarting...';
    document.body.style.filter='';
    setTimeout(()=> { document.body.style.filter='brightness(0)'; }, 600);
    // "boot up" after 3s
    setTimeout(()=> {
      document.body.style.filter='';
      powerOverlay.style.display='none';
    }, 3200);
  }

  function flashlight(on){
    flashlightOverlay.style.display = on ? 'flex' : 'none';
  }

  async function openCamera(){
    try{
      cameraOverlay.style.display='flex';
      if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
      camStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: usingBackCam ? {ideal:'environment'} : 'user' },
        audio: false
      });
      camVideo.srcObject = camStream;
      addLog('Camera opened');
    }catch(e){
      addLog('Camera error: ' + e.message);
      alert('Camera permission or device error.');
    }
  }
  function closeCamera(){
    cameraOverlay.style.display='none';
    if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
    addLog('Camera closed');
  }
  btnCloseCamera.addEventListener('click', closeCamera);
  btnSwitchCamera.addEventListener('click', async ()=>{
    usingBackCam = !usingBackCam;
    await openCamera();
  });

  async function batteryStatus(){
    try{
      if(!('getBattery' in navigator)){ alert('Battery API not supported'); return; }
      const b = await navigator.getBattery();
      const pct = Math.round(b.level*100);
      const ch = b.charging ? 'charging' : 'not charging';
      alert(`Battery: ${pct}% (${ch})`);
      addLog(`Battery status: ${pct}% (${ch})`);
    }catch(e){ addLog('Battery error: '+e.message); }
  }

  function deviceInfo(){
    const ua = navigator.userAgent;
    const plat = navigator.platform;
    const lang = navigator.language;
    const info = `UA: ${ua}\nPlatform: ${plat}\nLanguage: ${lang}`;
    alert(info);
    addLog('Device info shown');
  }

  async function keepScreenOn(){
    try{
      if('wakeLock' in navigator){
        wakeLock = await navigator.wakeLock.request('screen');
        addLog('Wake Lock active (screen on)');
        window.addEventListener('visibilitychange', async ()=>{
          if(document.visibilityState === 'visible' && wakeLock === null){
            try{ wakeLock = await navigator.wakeLock.request('screen'); }catch(_){}
          }
        });
      } else {
        alert('Wake Lock API not supported in this browser');
      }
    }catch(e){ addLog('Wake Lock error: '+e.message); }
  }
  function allowSleep(){
    if(wakeLock){ try{ wakeLock.release(); }catch(_){} wakeLock=null; addLog('Wake Lock released'); }
  }

  function vibrate(){
    if('vibrate' in navigator){
      navigator.vibrate([60,40,60,40,120]);
      addLog('Vibration pattern played');
    } else {
      alert('Vibration not supported on this device');
    }
  }

  function lockScreen(){
    lockOverlay.style.display='flex';
  }
  function unlockScreen(){
    lockOverlay.style.display='none';
  }
  unlockBtn.addEventListener('click', unlockScreen);

  function openWhatsApp(){
    try{
      window.location.href = "intent://send/#Intent;scheme=whatsapp;package=com.whatsapp;end";
      setTimeout(()=>window.open('https://web.whatsapp.com', '_blank'), 800);
    }catch(_){
      window.open('https://web.whatsapp.com', '_blank');
    }
    addLog('WhatsApp request');
  }

  function openGallery(){
    window.open('https://photos.google.com', '_blank');
    addLog('Gallery opened');
  }

  // ---------- Command router ----------
  function handleExtraCommand(raw){
    if(!raw) return false;
    const lower = raw.toLowerCase().trim();

    // map variants
    if(/^(power\s*off( phone)?|shutdown( phone)?)$/.test(lower)){ powerOffAnimation(); return true; }
    if(/^(restart( phone)?|reboot( phone)?)$/.test(lower)){ restartAnimation(); return true; }

    if(/^(flashlight|torch) on$/.test(lower)){ flashlight(true); return true; }
    if(/^(flashlight|torch) off$/.test(lower)){ flashlight(false); return true; }

    if(/^open camera$/.test(lower)){ openCamera(); return true; }
    if(/^close camera$/.test(lower)){ closeCamera(); return true; }

    if(/^open whatsapp$/.test(lower)){ openWhatsApp(); return true; }
    if(/^open gallery$/.test(lower)){ openGallery(); return true; }

    if(/^battery status$/.test(lower)){ batteryStatus(); return true; }
    if(/^device info$/.test(lower)){ deviceInfo(); return true; }

    if(/^keep screen on$/.test(lower)){ keepScreenOn(); return true; }
    if(/^allow sleep$/.test(lower)){ allowSleep(); return true; }

    if(/^vibrate$/.test(lower)){ vibrate(); return true; }

    if(/^lock screen$/.test(lower)){ lockScreen(); return true; }
    if(/^unlock screen$/.test(lower)){ unlockScreen(); return true; }

    return false;
  }

  // 1) Intercept typed commands BEFORE original handler (capture phase)
  btnSend.addEventListener('click', function(e){
    const val = (cmdInput && cmdInput.value || '').trim();
    if(handleExtraCommand(val)){
      // clear to prevent original handler from acting
      if(cmdInput) cmdInput.value = '';
      e.stopImmediatePropagation();
      e.preventDefault();
    }
  }, true);
  cmdInput.addEventListener('keydown', function(e){
    if(e.key==='Enter'){
      const val = (cmdInput && cmdInput.value || '').trim();
      if(handleExtraCommand(val)){
        if(cmdInput) cmdInput.value = '';
        e.stopImmediatePropagation();
        e.preventDefault();
      }
    }
  }, true);

  // 2) Observe transcript for "User: ..." lines produced by original code (voice path)
  const seen = new Set();
  const observer = new MutationObserver((muts)=>{
    muts.forEach(m=>{
      m.addedNodes && Array.from(m.addedNodes).forEach(node=>{
        if(node && node.textContent && node.textContent.startsWith('User: ')){
          const cmd = node.textContent.slice(6).trim();
          if(!seen.has(cmd)){
            seen.add(cmd);
            handleExtraCommand(cmd);
          }
        }
      });
    });
  });
  if(transcriptEl){
    observer.observe(transcriptEl, { childList:true });
  }

  // 3) Utility dock click â†’ run commands
  document.querySelectorAll('.util').forEach(card=>{
    card.addEventListener('click', ()=>{
      const c = card.getAttribute('data-cmd');
      handleExtraCommand(c);
    });
  });

})();
</script>
<!-- ===================== ADD-ONS END ===================== -->
</body>
</html>
